/* (c) Jonathan Gotti - licence: https://github.com/malko/d.js/LICENCE.txt @version 0.4.0*/
(function(n){"use strict";function e(n){r(function(){throw n})}function t(n,e){var t=c(n);if(1===t.length&&o(t[0])){if(!t[0].length)return a.fulfilled([]);t=t[0]}var r=[],u=a(),i=t.length;if(i)for(var s=(function(n){t[n]=a.promisify(t[n]),t[n].then(function(o){n in r||(r[n]=e?t[n]:o,--i||u.resolve(r))},function(o){n in r||(e?(r[n]=e?t[n]:v,--i||u.resolve(r)):u.reject(o))})}),l=0,f=i;f>l;l++)s(l);else u.resolve(r);return u.promise}var r,u=function(n){return n instanceof Function},o=function(n){return n instanceof Array},i=function(e){return e===!1||e===n||null===e},c=function(n,e){return[].slice.call(n,e)},s="undefined";if(typeof process!==s&&process.nextTick)r=process.nextTick;else if(typeof MessageChannel!==s){var l=new MessageChannel,f=[];l.port1.onmessage=function(){f.length&&f.shift()()},r=function(n){f.push(n),l.port2.postMessage(0)}}else r=function(n){setTimeout(n,0)};var a=function(t){function c(){if(0!==p){var n,e=v,t=0,r=e.length,u=~p?0:1;for(v=[];r>t;t++)(n=e[t][u])&&n.call(null,f)}}function s(n){return p?this:n&&u(n.then)?(n.then(s,l),this):(h(function(){f=n,p=1,c()}),this)}function l(n){return 0===p&&h(function(){try{throw n}catch(e){f=e}p=-1,c()}),this}var f,h=(n!==t?t:a.alwaysAsync)?r:function(n){n()},p=0,v=[],y=a.onlyFuncs,m={then:function(n,e){var t=a();return v.push([function(e){try{i(n)?t.resolve(e):t.resolve(u(n)?n.call(null,e):y?e:n)}catch(r){t.reject(r)}},function(n){if((i(e)||!u(e)&&y)&&t.reject(n),e)try{t.resolve(u(e)?e.call(null,n):e)}catch(r){t.reject(r)}}]),0!==p&&h(c),t.promise},success:function(e){return this.then(e,n)},error:function(e){return this.then(n,e)},apply:function(e,t){return this.then(function(n){return u(e)?e.apply(null,o(n)?n:[n]):y?n:e},t||n)},ensure:function(n){function e(){n()}return this.then(e,e),this},nodify:function(n){return this.then(function(e){return u(n)?n.apply(null,o(e)?e.splice(0,0,void 0)&&e:[void 0,e]):y?e:n},function(e){return n.call(null,e)})},rethrow:function(t){return this.then(n,t?function(n){throw t(n),n}:e)},isPending:function(){return!(0!==p)},getStatus:function(){return p}};return m.toSource=m.toString=m.valueOf=function(){return f===n?this:f},m.otherwise=m.error,m.spread=m.apply,{promise:m,resolve:s,fulfill:s,reject:l}};a.defer=a,a.nextTick=r,a.alwaysAsync=!0,a.onlyFuncs=!0,a.resolved=a.fulfilled=function(n){return a(!0).resolve(n).promise},a.rejected=function(n){return a(!0).reject(n).promise},a.wait=function(n){var e=a();return setTimeout(e.resolve,n||0),e.promise},a.delay=function(n,e){var t=a();return setTimeout(function(){try{t.resolve(n.apply(null))}catch(e){t.reject(e)}},e||0),t.promise},a.promisify=function(n){return n&&u(n.then)?n:a.resolved(n)},a.all=function(){return t(arguments,!1)},a.resolveAll=function(){return t(arguments,!0)},a.nodeCapsule=function(n,e){return e||(e=n,n=void 0),function(){var t=a(),r=c(arguments);r.push(function(n,e){n?t.reject(n):t.resolve(arguments.length>2?c(arguments,1):e)});try{e.apply(n,r)}catch(u){t.reject(u)}return t.promise}},typeof window!==s?window.D=a:module.exports=a})();