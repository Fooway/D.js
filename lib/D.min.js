/* (c) Jonathan Gotti - licence: https://github.com/malko/d.js/LICENCE.txt */
(function(){"use strict";function n(n){t(function(){throw n})}var t,r=function(n){return n instanceof Function},e=function(n){return n===!1||void 0===n||null===n},u=function(n,t){return[].slice.call(n,t)},i="undefined",o="length",c="promise",s="resolve",f="reject",l="then";if(typeof process!==i&&process.nextTick)t=process.nextTick;else if(typeof MessageChannel!==i){var a=new MessageChannel,h=[];a.port1.onmessage=function(){h[o]&&h.shift()()},t=function(n){h.push(n),a.port2.postMessage(0)}}else t=function(n){setTimeout(n,0)};var p=function(u){function i(n){n&&n.call(null,v)}function a(){if(0!==d){var n=m,t=0,r=n[o],e=~d?0:1;for(m=[];r>t;t++)i(n[t][e])}}function h(n){return d?this:n&&r(n[l])?(n[l](h,y),this):(v=n,d=1,u?t(a):a(),this)}function y(n){if(0!==d)return this;try{throw n}catch(r){v=r}return d=-1,u?t(a):a(),this}u||(u=p.alwaysAsync);var v,d=0,m=[],g=p.onlyFuncs,w={then:function(n,i){var o=p();return m.push([function(t){try{o[s](e(n)?t:r(n)?n.call(null,t):g?t:n)}catch(u){o[f](u)}},function(n){if((e(i)||!r(i)&&g)&&o[f](n),i)try{o[s](r(i)?i.call(null,n):i)}catch(t){o[f](t)}}]),0!==d&&(u?t(a):a()),o[c]},success:function(n){return this[l](n,null)},error:function(n){return this[l](null,n)},apply:function(n,t){return this[l](function(t){return r(n)?n.apply(null,t):g?t:n},t||null)},rethrow:function(t){return this[l](null,t?function(n){throw t(n),n}:n)},isPending:function(){return 0===d?!0:!1},getStatus:function(){return d}};return w.toSource=w.toString=w.valueOf=function(){return void 0===v?this:v},{promise:w,resolve:h,fulfill:h,reject:y}};p.defer=p,p.nextTick=t,p.alwaysAsync=!0,p.onlyFuncs=!0,p.resolved=p.fulfilled=function(n){return p(!0)[s](n)[c]},p.rejected=function(n){return p(!0)[f](n)[c]},p.wait=function(n){var t=p();return setTimeout(t[s],n||0),t[c]},p.delay=function(n,t){var r=p();return setTimeout(function(){try{r[s](n.apply(null))}catch(t){r[f](t)}},t||0),r[c]},p.promisify=function(n){return n&&r(n[l])?n:d.resolved(n)},p.all=function(){var n=arguments;if(1===n[o]&&n[0]instanceof Array){if(n[0][o])return p.all.apply(p,n[0]);var t=p();return t[s](n[0]),t[c]}var r=[],e=p(),i=u(n),a=i[o];if(a)for(var h=0,y=a;y>h;h++)(function(n){var t=p.promisify(i[n]);t[l](function(t){n in r||(r[n]=t,--a||e[s](r))},function(t){n in r||e[f](t)})})(h);else e[s](r);return e[c]},p.nodeCapsule=function(n,t){return t||(t=n,n=void 0),function(){var r=p(),e=u(arguments);e.push(function(n,t){n?r[f](n):r[s](arguments[o]>2?u(arguments,1):t)});try{t.apply(n,e)}catch(i){r.reject(i)}return r[c]}},typeof window!==i?window.D=p:module.exports=p})();