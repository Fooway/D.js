/* (c) Jonathan Gotti - licence: https://github.com/malko/d.js/LICENCE.txt */
(function(){"use strict";function n(n){e(function(){throw n})}var e,t=function(n){return n instanceof Function},r=function(n){return n===!1||void 0===n||null===n},o=function(n,e){return[].slice.call(n,e)},u="undefined";if(typeof process!==u&&process.nextTick)e=process.nextTick;else if(typeof MessageChannel!==u){var i=new MessageChannel,c=[];i.port1.onmessage=function(){c.length&&c.shift()()},e=function(n){c.push(n),i.port2.postMessage(0)}}else e=function(n){setTimeout(n,0)};var s=function(o){function u(n){n&&n.call(null,f)}function i(){if(0!==a){var n=h,e=0,t=n.length,r=~a?0:1;for(h=[];t>e;e++)u(n[e][r])}}function c(n){return a?this:n&&t(n.then)?(n.then(c,l),this):(f=n,a=1,o?e(i):i(),this)}function l(n){if(0!==a)return this;try{throw n}catch(t){f=t}return a=-1,o?e(i):i(),this}o||(o=s.alwaysAsync);var f,a=0,h=[],p=s.onlyFuncs,v={then:function(n,u){var c=s();return h.push([function(e){try{c.resolve(r(n)?e:t(n)?n.call(null,e):p?e:n)}catch(o){c.reject(o)}},function(n){if((r(u)||!t(u)&&p)&&c.reject(n),u)try{c.resolve(t(u)?u.call(null,n):u)}catch(e){c.reject(e)}}]),0!==a&&(o?e(i):i()),c.promise},success:function(n){return this.then(n,null)},error:function(n){return this.then(null,n)},apply:function(n,e){return this.then(function(e){return t(n)?n.apply(null,e):p?e:n},e||null)},rethrow:function(e){return this.then(null,e?function(n){throw e(n),n}:n)},isPending:function(){return 0===a?!0:!1},getStatus:function(){return a}};return v.toSource=v.toString=v.valueOf=function(){return void 0===f?this:f},{promise:v,resolve:c,fulfill:c,reject:l}};s.defer=s,s.nextTick=e,s.alwaysAsync=!0,s.onlyFuncs=!0,s.resolved=s.fulfilled=function(n){return s(!0).resolve(n).promise},s.rejected=function(n){return s(!0).reject(n).promise},s.wait=function(n){var e=s();return setTimeout(e.resolve,n||0),e.promise},s.delay=function(n,e){var t=s();return setTimeout(function(){try{t.resolve(n.apply(null))}catch(e){t.reject(e)}},e||0),t.promise},s.promisify=function(n){return n&&t(n.then)?n:s.resolved(n)},s.all=function(){var n=arguments;if(1===n.length&&n[0]instanceof Array){if(n[0].length)return s.all.apply(s,n[0]);var e=s();return e.resolve(n[0]),e.promise}var t=[],r=s(),u=o(n),i=u.length;if(i)for(var c=0,l=i;l>c;c++)(function(n){var e=s.promisify(u[n]);e.then(function(e){n in t||(t[n]=e,--i||r.resolve(t))},function(e){n in t||r.reject(e)})})(c);else r.resolve(t);return r.promise},s.nodeCapsule=function(n,e){return e||(e=n,n=void 0),function(){var t=s(),r=o(arguments);r.push(function(n,e){n?t.reject(n):t.resolve(arguments.length>2?o(arguments,1):e)});try{e.apply(n,r)}catch(u){t.reject(u)}return t.promise}},typeof window!==u?window.D=s:module.exports=s})();